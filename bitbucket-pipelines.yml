# Example Bitbucket Pipeline for client applications using devops-gcp-pulumi
#
# Copy this file to your application repository and customize APP_NAME below.
#
# Required Repository Variables:
#   GCP_PROJECT          - GCP project ID (infra project where Cloud Run deploys)
#   GCP_PROJECT_NUMBER   - GCP project number (for WIF)
#   GCP_REGION           - GCP region (e.g., us-central1)
#   STATE_BUCKET         - GCS bucket name for Pulumi state
#   SERVICE_ACCOUNT_EMAIL - Deploy service account email
#
# Required Repository Variables (Secured):
#   PULUMI_CONFIG_PASSPHRASE - State encryption passphrase
#
# Optional Repository Variables:
#   CPU_LIMIT            - CPU limit (default: 1)
#   MEMORY_LIMIT         - Memory limit (default: 512Mi)
#   MIN_INSTANCES        - Minimum instances (default: 0)
#   MAX_INSTANCES        - Maximum instances (default: 100)
#   RUNTIME_SERVICE_ACCOUNT_EMAIL - Runtime SA for apps with backend resources
#
# NOTE: Stack References
# ----------------------
# This pipeline uses "organization" as a literal string in stack references
# (e.g., "organization/infrastructure/prod"). This is the convention for
# self-managed Pulumi state backends (GCS, S3, Azure Blob). You do NOT need
# a Pulumi Cloud account - the state is stored in your GCS bucket.
#
# =============================================================================
# Apps with Backend Resources (Firestore, Firebase, Secret Manager, etc.)
# =============================================================================
#
# For stateless apps: No additional setup needed.
#
# For apps with backend resources in a separate GCP project:
#
#   1. Create runtime SA in your app's GCP project with required permissions:
#      gcloud iam service-accounts create app-runtime \
#        --project=APP-PROJECT \
#        --display-name="App Runtime Account"
#
#   2. Grant runtime SA access to your backend resources:
#      gcloud projects add-iam-policy-binding APP-PROJECT \
#        --member="serviceAccount:app-runtime@APP-PROJECT.iam.gserviceaccount.com" \
#        --role="roles/datastore.user"  # Firestore
#
#   3. Grant deploy SA permission to assign the runtime SA to Cloud Run:
#      gcloud iam service-accounts add-iam-policy-binding \
#        app-runtime@APP-PROJECT.iam.gserviceaccount.com \
#        --member="serviceAccount:pulumi-deploy@INFRA-PROJECT.iam.gserviceaccount.com" \
#        --role="roles/iam.serviceAccountUser"
#
#   4. Set RUNTIME_SERVICE_ACCOUNT_EMAIL in repository variables
#
# The Cloud Run service deploys to the infra project but runs as the runtime SA,
# which has cross-project access to your app's backend resources.
# =============================================================================

image: node:22-alpine

definitions:
  services:
    docker:
      memory: 2048

pipelines:
  default:
    - parallel:
        - step:
            name: Build and Test
            caches:
              - node
            script:
              - npm ci
              - npm run build
              - npm run lint
              - npx tsc --noEmit

        - step:
            name: Deploy to Cloud Run
            oidc: true
            services:
              - docker
            caches:
              - node
              - docker
            script:
              # Customize APP_NAME for your application
              - export APP_NAME=your-app-name
              - apk add --no-cache git curl bash
              - curl -fsSL https://get.pulumi.com | sh
              - export PATH=$PATH:$HOME/.pulumi/bin
              - git clone https://bitbucket.org/YOUR_WORKSPACE/devops-gcp-pulumi.git infra
              - cd infra/cli && npm ci && npm run build
              - npx devops-gcp deploy --app "$APP_NAME" --branch "$BITBUCKET_BRANCH" --context "$BITBUCKET_CLONE_DIR"
              - echo "Service URL - $(cat /tmp/service-url.txt)"

  custom:
    # Branch cleanup pipeline - triggered manually when a branch is deleted
    branch-cleanup:
      - variables:
          - name: DELETED_BRANCH
            description: "Name of the deleted branch to clean up"
        step:
          name: Cleanup Branch Resources
          oidc: true
          script:
            # Must match APP_NAME from deploy step
            - export APP_NAME=your-app-name
            - apk add --no-cache git curl bash
            - curl -fsSL https://get.pulumi.com | sh
            - export PATH=$PATH:$HOME/.pulumi/bin
            - git clone https://bitbucket.org/YOUR_WORKSPACE/devops-gcp-pulumi.git infra
            - cd infra/cli && npm ci && npm run build
            - npx devops-gcp cleanup --app "$APP_NAME" --branch "$DELETED_BRANCH"
